#cloud-config
# KJBot Complete Auto-Install Script v3.0
# Simplified deployment with GitHub-hosted backend

users:
  - name: kjbot
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

package_update: true
package_upgrade: true

packages:
  - python3
  - python3-pip
  - python3-venv
  - python3-dev
  - libssl-dev
  - libffi-dev
  - build-essential
  - cockpit
  - cockpit-ws
  - cockpit-system
  - git
  - curl
  - ufw
  - nginx

write_files:
  # KJBot Systemd Service
  - path: /etc/systemd/system/kjbot.service
    content: |
      [Unit]
      Description=KJBot Webhook Server
      After=network.target

      [Service]
      Type=simple
      User=kjbot
      WorkingDirectory=/opt/kjbot/backend
      Environment="PATH=/opt/kjbot/venv/bin"
      ExecStart=/opt/kjbot/venv/bin/python webhook_server.py
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target

  # Nginx Reverse Proxy Config (Single Port Architecture)
  - path: /etc/nginx/sites-available/kjbot
    content: |
      server {
          listen 80;
          server_name _;

          # Proxy to Cockpit (UI)
          location / {
              proxy_pass http://localhost:9090;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_http_version 1.1;
              proxy_set_header Upgrade $http_upgrade;
              proxy_set_header Connection "upgrade";
          }

          # Proxy to Backend (API)
          location /webhook {
              proxy_pass http://localhost:5000/webhook;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
          }

          location /api {
              proxy_pass http://localhost:5000/api;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
          }
      }

  # Sudoers config for kjbot service restart
  - path: /etc/sudoers.d/kjbot
    content: |
      kjbot ALL=(ALL) NOPASSWD: /bin/systemctl restart kjbot
    permissions: '0440'

runcmd:
  # Firewall setup
  - ufw --force enable
  - ufw allow 22/tcp
  - ufw allow 80/tcp
  - ufw allow 443/tcp
  - ufw allow 9090/tcp
  - ufw allow 5000/tcp
  - ufw reload

  # Cockpit configuration (prevent login issues)
  - systemctl enable cockpit.socket
  - systemctl start cockpit.socket
  - sleep 2
  - systemctl restart cockpit.socket

  # Create directories
  - mkdir -p /opt/kjbot/backend
  - mkdir -p /var/log/kjbot
  - mkdir -p /etc/kjbot
  - chown -R kjbot:kjbot /opt/kjbot
  - chown -R kjbot:kjbot /var/log/kjbot
  - chown -R kjbot:kjbot /etc/kjbot

  # Python virtual environment
  - sudo -u kjbot python3 -m venv /opt/kjbot/venv

  # Configure Cockpit (Allow Reverse Proxy)
  - |
    IP=$(hostname -I | awk '{print $1}')
    mkdir -p /etc/cockpit
    cat > /etc/cockpit/cockpit.conf <<EOF
    [WebService]
    Origins = http://$IP http://localhost wss://$IP wss://localhost
    ProtocolHeader = X-Forwarded-Proto
    AllowUnencrypted = true
    EOF

  # Enable Nginx - Remove default config to prevent 80 port conflict
  - rm -f /etc/nginx/sites-enabled/default
  - ln -sf /etc/nginx/sites-available/kjbot /etc/nginx/sites-enabled/
  - systemctl restart nginx

  # Download Backend files from GitHub (tar.gz archive)
  - curl -L https://github.com/KJ-Cheon/kjbot-files/raw/main/kjbot-backend.tar.gz -o /tmp/kjbot-backend.tar.gz
  - tar -xzf /tmp/kjbot-backend.tar.gz -C /opt/kjbot/backend/
  - rm -f /tmp/kjbot-backend.tar.gz
  
  # Install Python packages
  - sudo -u kjbot /opt/kjbot/venv/bin/pip install --upgrade pip
  - sudo -u kjbot /opt/kjbot/venv/bin/pip install -r /opt/kjbot/backend/requirements.txt

  # Download Cockpit GUI from GitHub
  - curl -L https://github.com/KJ-Cheon/kjbot-files/raw/main/kjbot-manager-latest.tar.gz -o /tmp/kjbot-gui.tar.gz
  
  # Extract GUI to Cockpit directory
  - tar -xzf /tmp/kjbot-gui.tar.gz -C /usr/share/cockpit/
  - rm -f /tmp/kjbot-gui.tar.gz
  
  # Start KJBot
  - systemctl daemon-reload
  - systemctl enable kjbot
  - systemctl start kjbot

  # Final Cockpit restart to ensure GUI loads
  - sleep 2
  - systemctl restart cockpit
